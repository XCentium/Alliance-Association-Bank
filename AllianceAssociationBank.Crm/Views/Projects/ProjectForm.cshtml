@model ProjectFormViewModel
@{
    ViewBag.Title = "Projects";
}

<div class="row">

    @Html.Partial(ProjectsViews.SideMenuPartial)

    <nav class="col-11">
        <div class="nav nav-tabs small" id="nav-tab" role="tablist">
            <a class="nav-item nav-link active" id="nav-general-tab" data-toggle="tab" href="#nav-general-content" role="tab" aria-controls="nav-general-content" aria-selected="true">GENERAL</a>
            <a class="nav-item nav-link" id="nav-users-tab" data-toggle="tab" href="#nav-users-content" role="tab" aria-controls="nav-users-content" aria-selected="true">USERS</a>
            <a class="nav-item nav-link" id="nav-boarding-tab" data-toggle="tab" href="#nav-boarding-content" role="tab" aria-controls="nav-boarding-content" aria-selected="false">BOARDING</a>
            <a class="nav-item nav-link" id="nav-software-tab" data-toggle="tab" href="#nav-software" role="tab" aria-controls="nav-software" aria-selected="false">SOFTWARE</a>
            <a class="nav-item nav-link" id="nav-lockbox-tab" data-toggle="tab" href="#nav-lockbox" role="tab" aria-controls="nav-lockbox" aria-selected="false">LOCKBOX</a>
            <a class="nav-item nav-link" id="nav-ach-tab" data-toggle="tab" href="#nav-ach" role="tab" aria-controls="nav-ach" aria-selected="false">ACH</a>
            <a class="nav-item nav-link" id="nav-system-tab" data-toggle="tab" href="#nav-system" role="tab" aria-controls="nav-system" aria-selected="false">SYSTEM</a>
            <a class="nav-item nav-link" id="nav-accounts-tab" data-toggle="tab" href="#nav-accounts" role="tab" aria-controls="nav-accounts" aria-selected="false">ACCOUNTS / HOA DDAS</a>
        </div>
    </nav>

    <nav class="navbar p-2">
        <button class="btn-img" id="search-box-toggle" type="button" data-toggle="slide-collapse-left" data-target="#search-widget" aria-controls="search-widget" aria-expanded="false" aria-label="Search">
            <img src="~/Content/Images/search-img.png" />
        </button>
        <div class="collapse navbar-collapse popup-control" id="search-widget">
            <input class="form-control full-width" id="project-search" type="text" placeholder="NAME / CMC ID" autocomplete="off">
        </div>
    </nav>

</div>


@using (Html.BeginForm(Model.CreateUpdateAction, ControllerNames.Projects, FormMethod.Post, new { role = "form" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
    @Html.HiddenFor(m => m.ID)

    <div class="row mb-3">
        <div class="col-12 text-right">
            <span class="save-indicator">UNSAVED</span>
            <button class="btn-img" type="submit">
                <img class="icon-image" src="~/Content/Images/save-img.png" />
            </button>
            <button class="btn-img" type="button">
                <img class="icon-image" src="~/Content/Images/print-img.png" />
            </button>
            <button class="btn-img" type="reset">
                <img class="icon-image" src="~/Content/Images/close-img.png" />
            </button>
        </div>
    </div>

    <div class="row my-2 pb-1 border-bottom">
        <div class="col-4">
            <div class="row">
                @Html.LabelFor(m => m.ProjectName, new { @class = "col-2" })
                <div class="col-10">
                    @Html.EditorFor(m => m.ProjectName, new { htmlAttributes = new { @class = "form-input" } })
                    @Html.ValidationMessageFor(m => m.ProjectName, "", new { @class = "form-error-msg" })
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="row">
                @Html.LabelFor(m => m.DBA, new { @class = "col-2" })
                <div class="col-10">
                    @Html.EditorFor(m => m.DBA, new { htmlAttributes = new { @class = "form-input" } })
                    @Html.ValidationMessageFor(m => m.DBA, "", new { @class = "form-error-msg" })
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="row">
                @Html.LabelFor(m => m.OtherName, new { @class = "col-2" })
                <div class="col-10">
                    @Html.EditorFor(m => m.OtherName, new { htmlAttributes = new { @class = "form-input" } })
                    @Html.ValidationMessageFor(m => m.OtherName, "", new { @class = "form-error-msg" })
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="nav-tabs-content">
        <div class="tab-pane fade show active" id="nav-general-content" role="tabpanel" aria-labelledby="nav-general-tab">
            @Html.Partial(ProjectsViews.GeneralTabPartial)
        </div>
        <div class="tab-pane fade" id="nav-users-content" role="tabpanel" aria-labelledby="nav-users-tab">
            @Html.Partial(ProjectsViews.UsersTabPartial)
        </div>
        <div class="tab-pane fade" id="nav-boarding-content" role="tabpanel" aria-labelledby="nav-boarding-tab">
            @Html.Partial(ProjectsViews.BoardingTabPartial)
        </div>
    </div>
}

@* div to render user form modal *@
<div id="user-form-location"></div>


<div class="screen-overlay"></div>

@section scripts
{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/ajaxhelper")

    <script>

        $(document).ready(function () {

            // projects autocomplete search
            $("#project-search").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "/api/Projects",
                        method: "GET",
                        dataType: "json",
                        data: {
                            search: request.term
                        },
                        success: function (data) {
                            response($.map(data, function (item) {
                                return {
                                    label: item.name,
                                    value: item.id
                                };
                            }));
                        },
                        error: function () {
                            handleAjaxError();
                        }
                    });
                },
                minLength: 2,
                select: function (event, ui) {
                    event.preventDefault();
                    this.value = ui.item.label;
                    location.href = "/Projects/Edit/" + ui.item.value;
                }
            });


            $('[data-toggle="slide-collapse-right"]').on('click', function () {
                $toggleTarget = $($(this).data('target'));
                $toggleTarget.show("slide");

                $(".screen-overlay").fadeIn(500);
            });

            $('[data-toggle="slide-collapse-left"]').on('click', function () {
                $toggleTarget = $($(this).data('target'));
                $toggleTarget.show("slide", { direction: "right" })

                $(".screen-overlay").fadeIn(500);
            });

            $(".screen-overlay").click(function (event) {
                $("#nav-side-menu").hide('slide');
                $("#search-widget").hide('slide', { direction: "right" });

                $(".screen-overlay").fadeOut(500);
            });

            $("input[name='user-filter-option']").change(function (e) {
                var $radios = $(this);
                var projectId = $radios.attr("data-projectId");
                var filterValue = $radios.val();

                var url = "/Projects/" + projectId + "/Users/Index";

                $.get(url, { filter: filterValue })
                    .done(function (responseData) {
                        $("#project-users-list").html(responseData);
                    })
                    .fail(function () {
                        handleAjaxError();
                    });
            });

            //$("#btn-add-project-user").click(function (e) {
            //$("body").on("click", "#btn-add-project-user", function (e) {
            //    e.preventDefault();

            //    var url = "/ProjectUsers/Create";
            //    $.get(url)
            //        .done(function (responseData) {
            //            $("#user-form-location").html(responseData);
            //            $("#user-form-modal").modal("show")
            //        })
            //        .fail(function () {
            //            alert("An error occurred while processing your request");
            //        });
            //});

            //$(".btn-edit-project-user").click(function (e) {
            //$("body").on("click", ".btn-edit-project-user", function (e) {
            //    e.preventDefault();
            //    var userId = $(this).data("userid");

            //    var url = "/ProjectUsers/Edit";
            //    $.get(url, { id: userId })
            //        .done(function (responseData) {
            //            $("#user-form-location").html(responseData);
            //            $("#user-form-modal").modal("show")
            //        })
            //        .fail(function () {
            //            alert("An error occurred while processing your request");
            //        });
            //});

        });

        function showUserFormModal () {
            $("#user-form-modal").modal("show");

            validatorParseForm($("#user-form-element"));
        };

        function hideUserFormModal () {
            $("#user-form-modal").modal("hide");
        };

        function validatorParseForm (form) {
            $.validator.unobtrusive.parse(form);
        };

        function handleAjaxError () {
            alert("An error occurred while processing your request");
        };

        // TOOD: need more efficient solution
        // parsing the unobtrusive attributes when we get content via ajax
        //$(document).ajaxComplete(function () {
        //    $.validator.unobtrusive.parse(document);
        //});

    </script>
}